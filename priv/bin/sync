#!/bin/bash -eu

if [ ! -z "${DEBUG:-}" ]; then
    set -x
fi

account="$1"
project_dir="$2"
depot="$3"

abs_project_dir=$( (cd $project_dir && pwd) )
project_name=$(basename $abs_project_dir)
full_depot_path=$(echo $depot/data/$account/$project_name/ | sed s://*:/:g)

backup-or-preview-run-dbs() {
    local db bak bakgz
    for db in `find $project_dir/runs -name run.db`; do
        bak=$db.bak
        bakgz=$bak.gz
        if test $db -nt $bakgz; then
            if [ ! -z "${PREVIEW:-}" ]; then
                echo "$db is new or has changed"
            else
                echo "Snapshotting $db"
                echo ".backup $bak" | sqlite3 $db
                gzip -f $bak
            fi
        fi
    done
}

sync-or-preview-files() {
    rsync \
        $(rsync-preview-opts) \
        --verbose \
        --recursive \
        --links \
        --delete \
        --update \
        --include Guild \
        --include README.md \
        --exclude 'runs/*/guild.d/run.db' \
        --include 'runs/***' \
        --exclude '*' \
        $abs_project_dir/ $full_depot_path
}

rsync-preview-opts() {
    if [ ! -z "${PREVIEW:-}" ]; then
        echo "--list-only"
    fi
}

backup-or-preview-run-dbs
sync-or-preview-files
