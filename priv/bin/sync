#!/bin/bash -eu

account="$1"
project_dir="$2"
depot="$3"

abs_project_dir=$( (cd $project_dir && pwd) )
project_name=$(basename $abs_project_dir)
full_depot_path=$(echo $depot/data/$account/$project_name/ | sed s://*:/:g)

if [ ! -z "${PREVIEW:-}" ]; then
    preview_opts="--list-only"
    echo "account:          $account"
    echo "abs_project_dir:  $abs_project_dir"
    echo "depot:            $depot"
    echo "project_name:     $project_name"
    echo "full_depot_path:  $full_depot_path"
else
    preview_opts=""
fi

rsync \
    $preview_opts \
    -va \
    --include Guild \
    --exclude 'runs/*/guild.d/run.db' \
    --include 'runs/***' \
    --exclude '*' \
    $abs_project_dir/ $full_depot_path
